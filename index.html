<!DOCTYPE html>
<html>
  <head>
    <title>PDT - Mikuska</title>
    <meta name='viewport' content='initial-scale=1.0' charset='utf-8'>
	<link rel='icon' href='static/favicon.ico' type='image/x-icon'>
	<script src='http://code.jquery.com/jquery-3.1.1.min.js'></script>
    <style type='text/css'>
      html, body, #map {
        margin: 0;
        padding: 0;
        height: 100%;
      }
	  
	  .button{
	    cursor: pointer;
		font-weight:bold;
		border: 1px solid #ccc;
        background-color: #fff; 
        margin-top: 10px;
        padding: 10px 10px;
      }    
	  
	  .container{
	    cursor: pointer;
		width: 80px;
		height: 100px;
	  }
	
	  .blankDiv{
		position: absolute; 
		width: 13px; 
		height: 11px; 
		overflow-x: hidden; 
		overflow-y: hidden; 
		display: none;
	  }
		
	  .blankImg{
		position: absolute; 
		left: -52px; 
		top: -44px;
	  }
	  
	  .dropDownControl{
		position: relative; 
		cursor: pointer;
		font-weight:bold;
		border: 1px solid #ccc;
        background-color: #fff; 
        margin-top: 10px;
        padding: 10px 10px;
	  }	
	
	  .dropDownArrow{
 		position: absolute; 
		right: 6px; 
		margin-top: 6px;  
	  }
	
	  .dropDownOptionsDiv{
		background-color: white; 
		padding-top: 2px; 
		border: 1px solid #ccc;
		display: none;
		height: 90px;
	  }
  
      .button:hover, .checkboxContainer:hover{
		background-color: rgb(235, 235, 235);				
	  }
	
	  .checkboxContainer{
		padding-top: 3px; 
		padding-bottom: 3px; 
		padding-left: 5px; 
		padding-right: 8px; 
	  }	
	  
	  .checkboxSpan{
		margin-right: 5px;
		display: inline-block; 
		border-width: 1px; 
		border-style: solid; 
		width: 13px; 
		height: 13px; 
		border-color: rgb(200, 200, 200); 		
	  }
	
	  .checkboxLabel{
		cursor: pointer;
	  }
    </style>
	<script>
	  var map;
	  var types = [];
	  var images = {};
	  var markers = {};
	  var checkBoxes = {};
	  var checkBoxIds = [];
	  var dCoords = [];
	  var dBounds = [];
	  var dRegions = [];
	  var dColors = ['#000000', '#0000FF', '#00FF00', '#00FFFF',
	  				 '#FF0000', '#FF00FF', '#FFFF00', '#FFFFFF']

	  function initTypes() {
	  	$.ajax({
		  type: 'GET',
		  url: '/available_types'
		}).done(function(res) {
		  for (var i in res.types) {
		  	type = res.types[i];
		  	types.push(type);
		  	images[type] = 'static/icons/' + type + '.png';
		  	markers[type] = [];
		  	var newBox = new checkBox({
		  	  gmap: map,
		  	  title: 'Show ' + type,
		  	  id: type + 'Check',
		  	  label: type,
		  	  action: setMarkers
        	});
		  	checkBoxIds.push(newBox[0]);
		  	checkBoxes[type] = newBox[1];
		  }

		  var dropDownDiv = new dropDownOptionsDiv({
           items: checkBoxIds,
          	id: 'checkBoxDiv'        		
          });    

          var filterDropDown = new dropDownControl({
          	gmap: map,
          	name: 'Filters',
          	id: 'filters',
          	title: 'Dropdown to show filtered objects',
          	position: google.maps.ControlPosition.TOP_LEFT,
          	dropDown: dropDownDiv,
          	func:  function() {
		  	  (document.getElementById('checkBoxDiv').style.display == 'block') ? document.getElementById('checkBoxDiv').style.display = 'none' : document.getElementById('checkBoxDiv').style.display = 'block'
	 		}
          });
		});
	  }

	  function initRegions() {
	  	$.ajax({
		  type: 'GET',
		  url: '/region_list'
		}).done(function(res) {
		  //l variable defines the length of arrays
		  var l = 0;
		  for (var i in res) {

		  	var json = JSON.parse(res[i]);
	    	for (var j in json.districts) {

	    	  var coords =  json.districts[j].coords;
	    	  dBounds[l] = new google.maps.LatLngBounds();
    		  dCoords[l] = [];
    		  for (var k in coords) {
    		  	var obj = new google.maps.LatLng(coords[k][1], coords[k][0]);
    		  	dCoords[l].push(obj);
    		  	dBounds[l].extend(obj);
    		  }
    		  dRegions[l] = new google.maps.Polygon({
	            paths: dCoords[l],
	            strokeColor: '#000000',
	            strokeOpacity: 0.8,
	            strokeWeight: 1,
	            fillColor: dColors[i],
	            fillOpacity: 0.35
 			  });
 			  dRegions[l++].setMap(map);
	    	}
	      }

	      getCurrentLocation(map);
		});
	  }

	  function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 48.1536, lng: 17.072},
          zoom: 8,
        });

        initTypes();
        initRegions();

        var clearButton = new buttonControl({
		  gmap: map,
	      name: 'ClearAll',
		  id: 'clearButton',
		  position: google.maps.ControlPosition.TOP_LEFT,
		  action: function() {
			removeMarkers();
		  }
        });

        var searchButton = new buttonControl({
		  gmap: map,
	      name: 'Search',
		  id: 'searchButton',
		  position: google.maps.ControlPosition.TOP_LEFT,
		  action: function() {
			$.ajax({
			  type: 'GET',
			  url: '/show_all'
			}).done(function(res) {
			  removeMarkers();
			  for (var i in res) {
			  	var json = JSON.parse(res[i])
				var lat = json.lat;
				var lng = json.lng;
				var type = json.type;
				
				markers[type].push(new google.maps.Marker({
				  map: map,
				  position: {lat: lat, lng: lng},
				  icon: images[type],
				  visible: (checkBoxes[type].style.display == 'block')
				}));
			  }
			  setMarkers();
			});
		  }
        });
      }

      function getCurrentLocation(map) {
      	if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            var pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            map.setCenter(pos);
          }, function() {
            handleLocationError(true, marker, map.getCenter());
          });
        } else {
          handleLocationError(false, marker, map.getCenter());
        }
      }
	  
	  function setMarkers() {
	  	for (var i in types) {
		  if (checkBoxes[types[i]].style.display == 'block') {
	        for (var j in markers[types[i]]) {
		      markers[types[i]][j].setVisible(true);
		    }
		  } else {
		    for (var j in markers[types[i]]) {
		      markers[types[i]][j].setVisible(false);
			}
		  }
		}
	  }
	  
	  function removeMarkers() {
	  	for (var i in types) {
		  for (var j in markers[types[i]]) {
		    markers[types[i]][j].setMap(null);
			markers[types[i]][j] = null;
		  }
		  markers[types[i]] = [];
		}
	  }
	  
	  function buttonControl(options) {
		var control = document.createElement('DIV');
		control.innerHTML = options.name;
		control.className = 'button';
		control.index = 1;

		options.gmap.controls[options.position].push(control);

		google.maps.event.addDomListener(control, 'click', options.action);
		return control;
	  }
	  
	  function optionDiv(options){
	   	var control = document.createElement('DIV');
	   	control.innerHTML = options.name;
	   	control.className = options.bold ? 'dropDownBoldItemDiv' : 'dropDownItemDiv';
	   	control.title = options.title;

	   	google.maps.event.addDomListener(control, 'click', options.action);
	   	return control;
     }
     
      function checkBox(options){
     	var container = document.createElement('DIV');
   	  	container.className = 'CheckboxContainer';

     	var span = document.createElement('SPAN');
     	span.role = 'checkbox';
     	span.className = 'checkboxSpan';
     	        	        	
     	var bDiv = document.createElement('DIV');
   	  	bDiv.className = 'blankDiv';      	  	
   	  	bDiv.id = options.id;
		bDiv.style.display = 'block';
   	  	
   	  	var image = document.createElement('IMG');
   	  	image.className = 'blankImg';
   	  	image.src = 'http://maps.gstatic.com/mapfiles/mv/imgs8.png';
   	  	
   	  	var label = document.createElement('LABEL');
   	  	label.className = 'checkboxLabel';
   	  	label.innerHTML = options.label;
   	  	
   	  	bDiv.appendChild(image);
   	  	span.appendChild(bDiv);
   	  	container.appendChild(span);
   	  	container.appendChild(label);
   	  	
   	  	google.maps.event.addDomListener(container, 'click', function() {
   	  	  (document.getElementById(bDiv.id).style.display == 'block') ? document.getElementById(bDiv.id).style.display = 'none' : document.getElementById(bDiv.id).style.display = 'block';
		  options.action(); 
   	  	})
   	  	return [container, bDiv];
	  }
	  
      function dropDownOptionsDiv(options) {
      	var container = document.createElement('DIV');
      	container.className = 'dropDownOptionsDiv';
      	container.id = options.id;
      	
      	for (var i in options.items) {
      	  container.appendChild(options.items[i]);
      	}     
 		return container;        	
      }	  
     
      function dropDownControl(options) {
    	var container = document.createElement('DIV');
    	container.className = 'container';
    	  
		var control = document.createElement('DIV');
		control.className = 'dropDownControl';
		control.innerHTML = options.name;
		
		var arrow = document.createElement('IMG');
		arrow.className = 'dropDownArrow';
		arrow.src = 'http://maps.gstatic.com/mapfiles/arrow-down.png';
		
		control.appendChild(arrow);	      		
		container.appendChild(control);    
		container.appendChild(options.dropDown);
    	  
		options.gmap.controls[options.position].push(container);
		google.maps.event.addDomListener(control, 'click', options.func);  	  
      }
	  	  
      function handleLocationError(browserHasGeolocation, marker, pos) {
        marker.setPosition(pos);
        marker.setContent(browserHasGeolocation ? 'Error: The Geolocation service failed.' : 'Error: Your browser doesn\'t support geolocation.');  
	  }
    </script>
    <script src='https://maps.googleapis.com/maps/api/js?key=AIzaSyAj8WPBWxG3AHFz19UjdZG8Eon91ZPaqa8&language=en&callback=initMap'
    async defer></script>
  </head>
  <body>
    <div id='map'></div>
  </body>
</html>